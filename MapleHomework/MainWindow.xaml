<ui:FluentWindow x:Class="MapleHomework.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:vm="clr-namespace:MapleHomework.ViewModels"
        xmlns:models="clr-namespace:MapleHomework.Models"
        xmlns:converters="clr-namespace:MapleHomework.Converters"
        mc:Ignorable="d"
        Title="Maple Scheduler"
        Icon="icon.ico"
        Height="950" Width="820"
        ResizeMode="CanResizeWithGrip"
        Topmost="True"
        ExtendsContentIntoTitleBar="True"
        WindowBackdropType="Mica"
        UseLayoutRounding="True"
        Background="{DynamicResource WindowBackground}">

    <ui:FluentWindow.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:InverseBoolToVisConverter x:Key="InverseBoolToVis"/>
        <converters:DifficultyColorConverter x:Key="DifficultyColorConverter"/>
        <converters:CategoryToStringConverter x:Key="CategoryToStringConverter"/>
        <converters:CategoryToColorConverter x:Key="CategoryToColorConverter"/>
        <converters:ProgressToDashArrayConverter x:Key="ProgressToDashArrayConverter"/>

        <!-- 기존 난이도 뱃지 스타일 (DifficultyColorConverter 사용) -->
        <Style x:Key="DifficultyBadgeStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Padding" Value="6,2"/>
            <Setter Property="Margin" Value="5,0,0,0"/>
            <Setter Property="MinWidth" Value="50"/>
            <Setter Property="Background" Value="{Binding Difficulty, Converter={StaticResource DifficultyColorConverter}}"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding Difficulty}" Value="Chaos">
                    <Setter Property="Background" Value="#2A2A2A"/>
                    <Setter Property="BorderBrush" Value="#E8DCCA"/>
                    <Setter Property="BorderThickness" Value="1"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Difficulty}" Value="Extreme">
                    <Setter Property="Background" Value="#2A2A2A"/>
                    <Setter Property="BorderBrush" Value="#FF4500"/>
                    <Setter Property="BorderThickness" Value="1"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="DifficultyTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding Difficulty}" Value="Chaos">
                    <Setter Property="Foreground">
                        <Setter.Value>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                <GradientStop Color="#F5F5DC" Offset="0"/>
                                <GradientStop Color="#C4A484" Offset="1"/>
                            </LinearGradientBrush>
                        </Setter.Value>
                    </Setter>
                </DataTrigger>
                <DataTrigger Binding="{Binding Difficulty}" Value="Extreme">
                    <Setter Property="Foreground">
                        <Setter.Value>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                <GradientStop Color="#FFA500" Offset="0"/>
                                <GradientStop Color="#FF0000" Offset="1"/>
                            </LinearGradientBrush>
                        </Setter.Value>
                    </Setter>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- [공통] 태스크 아이템 템플릿 (일반 모드) -->
        <DataTemplate x:Key="TaskItemTemplate">
            <Border x:Name="TaskCard" 
                    Background="{Binding DataContext.SurfaceContainer, RelativeSource={RelativeSource AncestorType=Window}}"
                    BorderBrush="{Binding DataContext.Outline, RelativeSource={RelativeSource AncestorType=Window}}"
                    BorderThickness="1" CornerRadius="8" Padding="12,12" Margin="0,0,8,8" Cursor="Hand"
                    RenderTransformOrigin="0.5,0.5">
                <Border.RenderTransform>
                    <TransformGroup>
                        <ScaleTransform/>
                        <TranslateTransform/>
                    </TransformGroup>
                </Border.RenderTransform>
                <Border.InputBindings>
                    <MouseBinding MouseAction="LeftClick" 
                                  Command="{Binding DataContext.ToggleTaskCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                  CommandParameter="{Binding}"/>
                </Border.InputBindings>
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Background" Value="{Binding DataContext.SurfaceContainer, RelativeSource={RelativeSource AncestorType=Window}}"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="BorderBrush" Value="{Binding Category, Converter={StaticResource CategoryToColorConverter}}"/>
                                <Setter Property="BorderThickness" Value="1.5"/>
                            </Trigger>
                            <DataTrigger Binding="{Binding IsChecked}" Value="True">
                                <DataTrigger.EnterActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetProperty="(Border.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleX)"
                                                             From="1.0" To="0.95" Duration="0:0:0.1" AutoReverse="True"/>
                                            <DoubleAnimation Storyboard.TargetProperty="(Border.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleY)"
                                                             From="1.0" To="0.95" Duration="0:0:0.1" AutoReverse="True"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.EnterActions>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- 카테고리 뱃지 -->
                    <Grid Margin="0,0,10,0" VerticalAlignment="Center">
                        <Border CornerRadius="4" Padding="8,4" Background="{Binding Category, Converter={StaticResource CategoryToColorConverter}}" Opacity="0.2"/>
                        <TextBlock Text="{Binding Category, Converter={StaticResource CategoryToStringConverter}}" 
                                   Foreground="{Binding Category, Converter={StaticResource CategoryToColorConverter}}"
                                   FontSize="10" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Grid>

                    <TextBlock Grid.Column="1" Text="{Binding Name}" 
                               Foreground="{Binding DataContext.OnSurface, RelativeSource={RelativeSource AncestorType=Window}}" 
                               FontSize="14" FontWeight="Medium" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>

                    <!-- 난이도 뱃지 (보스 전용) -->
                    <Border Grid.Column="2" Margin="5,0,0,0">
                         <Border.Style>
                             <Style TargetType="Border" BasedOn="{StaticResource DifficultyBadgeStyle}">
                                 <Setter Property="Visibility" Value="Collapsed"/>
                                 <Style.Triggers>
                                     <DataTrigger Binding="{Binding Category}" Value="Boss">
                                         <Setter Property="Visibility" Value="Visible"/>
                                     </DataTrigger>
                                 </Style.Triggers>
                             </Style>
                         </Border.Style>
                        <TextBlock Text="{Binding Difficulty}" Style="{StaticResource DifficultyTextStyle}"/>
                    </Border>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- [공통] 태스크 편집 템플릿 (편집 모드) -->
        <DataTemplate x:Key="TaskEditTemplate">
            <Border Background="{Binding DataContext.SurfaceContainer, RelativeSource={RelativeSource AncestorType=Window}}"
                    BorderBrush="{Binding DataContext.Outline, RelativeSource={RelativeSource AncestorType=Window}}"
                    BorderThickness="1" CornerRadius="8" Padding="16,14" Margin="0,0,0,8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <TextBlock Text="{Binding Name}" Foreground="{Binding DataContext.OnSurface, RelativeSource={RelativeSource AncestorType=Window}}" 
                               VerticalAlignment="Center" FontWeight="Medium" FontSize="15"/>

                    <!-- 보스 옵션: 파티원 수 & 난이도 -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <StackPanel.Style>
                            <Style TargetType="StackPanel">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Category}" Value="Boss">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Category}" Value="Monthly">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </StackPanel.Style>
                        
                        <!-- 파티원 수 -->
                        <ComboBox Width="90" Margin="8,0"
                                  ItemsSource="{Binding DataContext.PartySizeOptions, RelativeSource={RelativeSource AncestorType=Window}}"
                                  SelectedValue="{Binding PartySize, Mode=TwoWay}"
                                  SelectedValuePath="Count"
                                  DisplayMemberPath="Display"
                                  IsSynchronizedWithCurrentItem="False"/>
                        <!-- 난이도 -->
                        <ComboBox Width="110" Margin="0,0,8,0" 
                                  ItemsSource="{Binding AvailableDifficulties}"
                                  SelectedItem="{Binding Difficulty, Mode=TwoWay}"
                                  IsSynchronizedWithCurrentItem="False"
                                  Style="{StaticResource {x:Type ComboBox}}"/>
                    </StackPanel>

                    <ui:ToggleSwitch Grid.Column="3" IsChecked="{Binding IsActive}" VerticalAlignment="Center"/>
                </Grid>
            </Border>
        </DataTemplate>



    </ui:FluentWindow.Resources>

    <ui:FluentWindow.Triggers>
        <EventTrigger RoutedEvent="ui:FluentWindow.Loaded">
            <BeginStoryboard>
                <Storyboard>
                    <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.3"/>
                </Storyboard>
            </BeginStoryboard>
        </EventTrigger>
    </ui:FluentWindow.Triggers>

    <Grid Background="{DynamicResource WindowBackground}">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="48"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- 메이플 스타일 타이틀바 (다크 슬레이트) -->
                <Border Grid.Row="0" Background="#3D4A5C" MouseLeftButtonDown="TitleBar_MouseLeftButtonDown" CornerRadius="12,12,0,0">
                <Grid>
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Left">
                            <!-- 사이드바 토글 버튼 -->
                            <Button Command="{Binding ToggleSidebarCommand}" Width="40" Height="32" Padding="0"
                                    Background="Transparent" BorderThickness="0" Cursor="Hand" ToolTip="전체 캐릭터 현황"
                                    HorizontalContentAlignment="Center" VerticalContentAlignment="Center" Margin="8,0,0,0">
                                <ui:SymbolIcon FontSize="18" Foreground="#5AC8FA">
                                    <ui:SymbolIcon.Style>
                                        <Style TargetType="ui:SymbolIcon">
                                            <Setter Property="Symbol" Value="ChevronLeft24"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsSidebarOpen}" Value="True">
                                                    <Setter Property="Symbol" Value="ChevronRight24"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ui:SymbolIcon.Style>
                                </ui:SymbolIcon>
                            </Button>
                    <TextBlock Text="MAPLE SCHEDULER" Foreground="White" FontWeight="Bold" FontSize="13" 
                                       VerticalAlignment="Center" Margin="8,0,0,0"/>
                        </StackPanel>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,4,0">
                        <ToggleButton Command="{Binding ToggleEditModeCommand}" Width="46" Height="32" Padding="0"
                                      Background="Transparent" BorderThickness="0" Cursor="Hand" ToolTip="편집 모드"
                                      IsChecked="{Binding IsEditMode, Mode=OneWay}"
                                      HorizontalContentAlignment="Center" VerticalContentAlignment="Center">
                            <ui:SymbolIcon Symbol="Edit24" FontSize="18" Foreground="#B0BEC5"/>
                        </ToggleButton>
                        <Button Click="MinimizeButton_Click" Width="46" Height="32" Padding="0"
                                Background="Transparent" BorderThickness="0" Cursor="Hand" ToolTip="최소화"
                                HorizontalContentAlignment="Center" VerticalContentAlignment="Center">
                            <ui:SymbolIcon Symbol="Subtract24" FontSize="18" Foreground="#B0BEC5"/>
                        </Button>
                        <Button Click="CloseButton_Click" Width="46" Height="32" Padding="0"
                                Background="Transparent" BorderThickness="0" Cursor="Hand" ToolTip="닫기"
                                HorizontalContentAlignment="Center" VerticalContentAlignment="Center">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border Background="{TemplateBinding Background}" SnapsToDevicePixels="True">
                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#E81123"/>
                                            <Setter Property="Foreground" Value="White"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                            <ui:SymbolIcon Symbol="Dismiss24" FontSize="18" Foreground="#B0BEC5"/>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- 메인 컨텐츠 영역 -->
            <Border Grid.Row="1" Background="{Binding Surface}">
                <Grid>
                    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="0,0,4,0">
                        <StackPanel Margin="16,12,16,16">

                            <!-- 캐릭터 정보 카드 + 원형 진행률 게이지 -->
                            <Border Background="{Binding SurfaceContainer}" CornerRadius="12" Padding="6,12,12,12" Margin="0,0,0,16" 
                                    BorderBrush="{Binding Outline}" BorderThickness="1">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- 캐릭터 이미지 (클릭하면 캐릭터 선택) -->
                                    <Border Width="100" Height="100" ClipToBounds="True" Background="Transparent" Margin="-4,0,0,0"
                                            Cursor="Hand" ToolTip="캐릭터 변경">
                                        <Border.InputBindings>
                                            <MouseBinding MouseAction="LeftClick" Command="{Binding ToggleCharacterSelectorCommand}"/>
                                        </Border.InputBindings>
                                        <Grid>
                                                <Border>
                                                    <Border.Background>
                                                        <ImageBrush Stretch="Uniform"
                                                                    ImageSource="{Binding DataContext.CharacterImage, RelativeSource={RelativeSource AncestorType=Border}, TargetNullValue={x:Null}, FallbackValue={x:Null}}">
                                                            <ImageBrush.RelativeTransform>
                                                                <ScaleTransform CenterX="0.48" CenterY="0.58" ScaleX="3.0" ScaleY="3.0"/>
                                                            </ImageBrush.RelativeTransform>
                                                        </ImageBrush>
                                                    </Border.Background>
                                                </Border>
                                            <!-- 캐릭터 전환 아이콘 오버레이 -->
                                            <Border Background="#80000000" CornerRadius="4" 
                                                    HorizontalAlignment="Right" VerticalAlignment="Bottom"
                                                    Padding="4" Margin="0,0,4,4">
                                                <ui:SymbolIcon Symbol="ArrowSwap20" FontSize="14" Foreground="White"/>
                                            </Border>
                                        </Grid>
                                    </Border>

                                    <!-- 캐릭터 정보 -->
                                    <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center">
                                        <TextBlock Text="{Binding CharacterName}" Foreground="{Binding OnSurface}" FontWeight="Bold" FontSize="19" Margin="0,0,0,6"/>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                            <Border Background="{StaticResource MapleCyanGradient}" CornerRadius="4" Padding="10,4">
                                                <TextBlock Text="{Binding WorldName}" Foreground="White" FontSize="11" FontWeight="SemiBold"/>
                                            </Border>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Lv." Foreground="{Binding Primary}" FontWeight="Bold" FontSize="12"/>
                                            <TextBlock Text="{Binding CharacterLevel}" Foreground="{Binding OnSurface}" FontWeight="Bold" FontSize="15" Margin="2,0,10,0"/>
                                            <TextBlock Text="{Binding CharacterClass}" Foreground="{Binding OnSurfaceVariant}" FontSize="12"/>
                                        </StackPanel>
                                    </StackPanel>

                                    <!-- 원형 진행률 게이지 -->
                                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="10,0,0,0">
                                        <!-- Daily (둘레 = π × (54-6) ≈ 150.8) -->
                                        <StackPanel Margin="0,0,10,0" HorizontalAlignment="Center">
                                            <Grid Width="54" Height="54">
                                                <Ellipse Stroke="{Binding Outline}" StrokeThickness="6" Fill="Transparent"/>
                                                <Ellipse Stroke="{StaticResource MapleCyanGradient}" StrokeThickness="6" Fill="Transparent"
                                                         StrokeDashArray="{Binding DailyProgress, Converter={StaticResource ProgressToDashArrayConverter}}" 
                                                         StrokeDashOffset="{Binding DailyProgressOffset}"
                                                         StrokeStartLineCap="Round" StrokeEndLineCap="Round">
                                                    <Ellipse.RenderTransform>
                                                        <RotateTransform Angle="-90" CenterX="27" CenterY="27"/>
                                                    </Ellipse.RenderTransform>
                                                </Ellipse>
                                                <TextBlock Text="{Binding DailyProgress, StringFormat={}{0:0}}" FontSize="16" FontWeight="Bold" 
                                                           HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{Binding OnSurface}"/>
                                            </Grid>
                                            <TextBlock Text="일일" FontSize="11" Foreground="{Binding OnSurfaceVariant}" HorizontalAlignment="Center" Margin="0,4,0,0"/>
                                        </StackPanel>
                                        <!-- Weekly -->
                                        <StackPanel Margin="0,0,10,0" HorizontalAlignment="Center">
                                            <Grid Width="54" Height="54">
                                                <Ellipse Stroke="{Binding Outline}" StrokeThickness="6" Fill="Transparent"/>
                                                <Ellipse Stroke="#FF9500" StrokeThickness="6" Fill="Transparent"
                                                         StrokeDashArray="{Binding WeeklyProgress, Converter={StaticResource ProgressToDashArrayConverter}}" 
                                                         StrokeDashOffset="{Binding WeeklyProgressOffset}"
                                                         StrokeStartLineCap="Round" StrokeEndLineCap="Round">
                                                    <Ellipse.RenderTransform>
                                                        <RotateTransform Angle="-90" CenterX="27" CenterY="27"/>
                                                    </Ellipse.RenderTransform>
                                                </Ellipse>
                                                <TextBlock Text="{Binding WeeklyProgress, StringFormat={}{0:0}}" FontSize="16" FontWeight="Bold" 
                                                           HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{Binding OnSurface}"/>
                                            </Grid>
                                            <TextBlock Text="주간" FontSize="11" Foreground="{Binding OnSurfaceVariant}" HorizontalAlignment="Center" Margin="0,4,0,0"/>
                                        </StackPanel>
                                        <!-- Boss -->
                                        <StackPanel HorizontalAlignment="Center">
                                            <Grid Width="54" Height="54">
                                                <Ellipse Stroke="{Binding Outline}" StrokeThickness="6" Fill="Transparent"/>
                                                <Ellipse Stroke="#FF3B30" StrokeThickness="6" Fill="Transparent"
                                                         StrokeDashArray="{Binding BossProgress, Converter={StaticResource ProgressToDashArrayConverter}}" 
                                                         StrokeDashOffset="{Binding BossProgressOffset}"
                                                         StrokeStartLineCap="Round" StrokeEndLineCap="Round">
                                                    <Ellipse.RenderTransform>
                                                        <RotateTransform Angle="-90" CenterX="27" CenterY="27"/>
                                                    </Ellipse.RenderTransform>
                                                </Ellipse>
                                                <TextBlock Text="{Binding BossProgress, StringFormat={}{0:0}}" FontSize="16" FontWeight="Bold" 
                                                           HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{Binding OnSurface}"/>
                                            </Grid>
                                            <TextBlock Text="보스" FontSize="11" Foreground="{Binding OnSurfaceVariant}" HorizontalAlignment="Center" Margin="0,4,0,0"/>
                                        </StackPanel>
                                    </StackPanel>
                                </Grid>
                            </Border>

                            <!-- 동적 태스크 섹션 (Daily, Weekly, Boss, Monthly) -->
                            <ItemsControl ItemsSource="{Binding ActiveSectionsView}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Margin="0,0,0,16">
                                            <!-- 섹션 헤더 -->
                                            <Border CornerRadius="8" Padding="12,12,16,12" Margin="0,0,0,10" Background="{Binding HeaderBackground}">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>

                                                    <Button Command="{Binding ToggleFavoriteCommand}" Width="28" Height="28" Padding="0"
                                                            Background="Transparent" BorderThickness="0" Cursor="Hand" ToolTip="즐겨찾기"
                                                            VerticalAlignment="Center" Margin="0,0,8,0">
                                                        <TextBlock FontSize="18" VerticalAlignment="Center" HorizontalAlignment="Center">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Setter Property="Text" Value="☆"/>
                                                                    <Setter Property="Foreground" Value="#FFFFFF"/>
                                                                    <Setter Property="Opacity" Value="0.5"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsFavorite}" Value="True">
                                                                            <Setter Property="Text" Value="★"/>
                                                                            <Setter Property="Foreground" Value="#FFD700"/>
                                                                            <Setter Property="Opacity" Value="1.0"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>
                                                    </Button>

                                                    <TextBlock Grid.Column="1" Text="{Binding Title}" Foreground="White" FontWeight="Bold" FontSize="15" VerticalAlignment="Center"/>

                                                    <!-- 보스 카운트 텍스트 (보스 섹션일 때만 보임) -->
                                                    <TextBlock Grid.Column="2" Text="{Binding SecondaryText}" 
                                                               Visibility="{Binding ShowSecondaryText, Converter={StaticResource BoolToVis}}"
                                                               Foreground="White" FontWeight="Bold" FontSize="14" 
                                                               VerticalAlignment="Center" Margin="0,0,16,0"/>


                                                </Grid>
                                            </Border>

                                            <!-- 일반 보기 -->
                                            <ItemsControl ItemsSource="{Binding ItemsView}" ItemTemplate="{StaticResource TaskItemTemplate}"
                                                          Visibility="{Binding DataContext.IsEditMode, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource InverseBoolToVis}}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <UniformGrid Columns="{Binding DataContext.TaskColumnCount, RelativeSource={RelativeSource AncestorType=Window}}"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                            </ItemsControl>

                                            <!-- 편집 모드 보기 -->
                                            <ItemsControl ItemsSource="{Binding ItemsView}" ItemTemplate="{StaticResource TaskEditTemplate}"
                                                          Visibility="{Binding DataContext.IsEditMode, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource BoolToVis}}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>


                            <!-- ═══════════════════════════════════════════ -->
                            <!-- 완료된 항목 섹션 (편집 모드가 아닐 때 + 완료 항목 있을 때만 표시) -->
                            <!-- ═══════════════════════════════════════════ -->
                            <StackPanel>
                                <StackPanel.Style>
                                    <Style TargetType="StackPanel">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding IsEditMode}" Value="False"/>
                                                    <Condition Binding="{Binding HasCompletedItems}" Value="True"/>
                                                </MultiDataTrigger.Conditions>
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </MultiDataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </StackPanel.Style>

                                <!-- 섹션 헤더 -->
                                <Border CornerRadius="8" Padding="12,12,16,12" Margin="0,16,0,10" Background="{StaticResource MapleFinishedGradient}">
                                    <Grid MinHeight="28">
                                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                            <ui:SymbolIcon Symbol="CheckmarkCircle24" FontSize="18" Foreground="White" Margin="0,0,10,0"/>
                                            <TextBlock Text="완료된 항목" Foreground="White" FontWeight="Bold" FontSize="15" VerticalAlignment="Center"/>
                                        </StackPanel>
                                        <TextBlock Text="{Binding CompletedList.Count, StringFormat='{}{0}개 완료'}" 
                                                   Foreground="White" FontWeight="Bold" FontSize="14" Opacity="0.9"
                                                   HorizontalAlignment="Right" VerticalAlignment="Center"/>
                                    </Grid>
                                </Border>

                                <!-- 완료된 항목 리스트 -->
                                <ItemsControl ItemsSource="{Binding CompletedList}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border x:Name="CompletedCard"
                                                    Background="{Binding DataContext.CompletedSurface, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    BorderBrush="{Binding DataContext.Outline, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    BorderThickness="1" CornerRadius="8" Padding="16,14" Margin="0,0,0,8" Cursor="Hand"
                                                    RenderTransformOrigin="0.5,0.5">
                                                <Border.RenderTransform>
                                                    <TransformGroup>
                                                        <ScaleTransform/>
                                                        <TranslateTransform/>
                                                    </TransformGroup>
                                                </Border.RenderTransform>
                                                <Border.InputBindings>
                                                    <MouseBinding MouseAction="LeftClick" 
                                                                  Command="{Binding DataContext.ToggleTaskCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                  CommandParameter="{Binding}"/>
                                                </Border.InputBindings>
                                                <Border.Style>
                                                    <Style TargetType="Border">
                                                        <Style.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="BorderBrush" Value="#4CD964"/>
                                                                <Setter Property="BorderThickness" Value="1.5"/>
                                                            </Trigger>
                                                            <!-- 복구 애니메이션 (체크 해제 시) -->
                                                            <DataTrigger Binding="{Binding IsChecked}" Value="False">
                                                                <DataTrigger.EnterActions>
                                                                    <BeginStoryboard>
                                                                        <Storyboard>
                                                                            <DoubleAnimation Storyboard.TargetProperty="(Border.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleX)"
                                                                                             From="0.95" To="1.0" Duration="0:0:0.2"/>
                                                                            <DoubleAnimation Storyboard.TargetProperty="(Border.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleY)"
                                                                                             From="0.95" To="1.0" Duration="0:0:0.2"/>
                                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                                             From="0.5" To="1.0" Duration="0:0:0.2"/>
                                                                        </Storyboard>
                                                                    </BeginStoryboard>
                                                                </DataTrigger.EnterActions>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Border.Style>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>

                                                    <!-- 완료 체크 아이콘 -->
                                                    <Border Width="24" Height="24" CornerRadius="12" Margin="0,0,14,0"
                                                            Background="#4CD964" VerticalAlignment="Center">
                                                        <ui:SymbolIcon Symbol="Checkmark16" FontSize="13" Foreground="White"
                                                                       HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>

                                                    <!-- 완료된 항목 이름 (취소선) -->
                                                    <TextBlock Grid.Column="1" Text="{Binding Name}" 
                                                               Foreground="{Binding DataContext.OnSurfaceVariant, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                               FontSize="15" FontWeight="Medium" VerticalAlignment="Center"
                                                               TextDecorations="Strikethrough" Opacity="0.7"/>

                                                    <!-- 카테고리 뱃지 -->
                                                    <Border Grid.Column="2" CornerRadius="4" Padding="10,5" Margin="10,0,0,0"
                                                            Background="{Binding Category, Converter={StaticResource CategoryToColorConverter}}"
                                                            Opacity="0.8" VerticalAlignment="Center">
                                                        <TextBlock Text="{Binding Category, Converter={StaticResource CategoryToStringConverter}}" 
                                                                   Foreground="White" FontSize="11" FontWeight="Bold"
                                                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>

                                                    <!-- 되돌리기 힌트 아이콘 -->
                                                    <ui:SymbolIcon Grid.Column="3" Symbol="ArrowUndo16" 
                                                                   FontSize="16" Foreground="{Binding DataContext.OnSurfaceVariant, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                                   Margin="12,0,0,0" Opacity="0.5" ToolTip="클릭하여 복구"/>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>

                        </StackPanel>
                    </ScrollViewer>

                    <!-- 기존 하단바 삭제됨 - 새 하단바는 Grid.Row="2"에 있음 -->
                </Grid>
            </Border>

            <!-- 캐릭터 선택 팝업 오버레이 -->
            <Border Grid.RowSpan="2" Background="#80000000" 
                    Visibility="{Binding IsCharacterSelectorOpen, Converter={StaticResource BoolToVis}}">
                <Border.InputBindings>
                    <MouseBinding MouseAction="LeftClick" Command="{Binding ToggleCharacterSelectorCommand}"/>
                </Border.InputBindings>
                
                <Border Background="{Binding SurfaceContainer}" CornerRadius="16" 
                        HorizontalAlignment="Center" VerticalAlignment="Center"
                        MaxWidth="500" MinWidth="350" MaxHeight="650"
                        Margin="20" Padding="24">
                    <Border.Effect>
                        <DropShadowEffect BlurRadius="30" ShadowDepth="8" Opacity="0.5"/>
                    </Border.Effect>
                    <Border.InputBindings>
                        <MouseBinding MouseAction="LeftClick" Command="{x:Null}"/>
                    </Border.InputBindings>
                    
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- 헤더 -->
                        <StackPanel Grid.Row="0" Margin="0,0,0,20">
                            <TextBlock Text="캐릭터 선택" Foreground="{Binding OnSurface}" 
                                       FontSize="24" FontWeight="Bold"/>
                            <TextBlock Text="{Binding Characters.Count, StringFormat='{}{0}/10 캐릭터'}" 
                                       Foreground="{Binding OnSurfaceVariant}" FontSize="14" Margin="0,4,0,0"/>
                        </StackPanel>

                        <!-- 캐릭터 리스트 -->
                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" MaxHeight="450">
                            <ItemsControl ItemsSource="{Binding Characters}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{Binding DataContext.Surface, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                CornerRadius="8" Margin="0,0,0,8" Padding="10" Cursor="Hand"
                                                BorderThickness="2">
                                            <Border.InputBindings>
                                                <MouseBinding MouseAction="LeftClick" 
                                                              Command="{Binding DataContext.SelectCharacterCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                              CommandParameter="{Binding}"/>
                                            </Border.InputBindings>
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="BorderBrush" Value="Transparent"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Value="True">
                                                            <DataTrigger.Binding>
                                                                <MultiBinding>
                                                                    <MultiBinding.Converter>
                                                                        <converters:EqualityConverter/>
                                                                    </MultiBinding.Converter>
                                                                    <Binding Path="."/>
                                                                    <Binding Path="DataContext.SelectedCharacter" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                                                </MultiBinding>
                                                            </DataTrigger.Binding>
                                                            <Setter Property="BorderBrush" Value="#5AC8FA"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="85"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <!-- 캐릭터 이미지 (70x70) -->
                                                <Border x:Name="CharacterAvatar" Width="70" Height="70" CornerRadius="35" Background="Transparent" ClipToBounds="True">
                                                    <Border>
                                                        <Border.Background>
                                                            <ImageBrush Stretch="UniformToFill"
                                                                        ImageSource="{Binding DataContext.ImageUrl, ElementName=CharacterAvatar, TargetNullValue={x:Null}, FallbackValue={x:Null}}">
                                                                <ImageBrush.RelativeTransform>
                                                                    <ScaleTransform CenterX="0.5" CenterY="0.55" ScaleX="3.6" ScaleY="3.6"/>
                                                                </ImageBrush.RelativeTransform>
                                                            </ImageBrush>
                                                        </Border.Background>
                                                    </Border>
                                                </Border>

                                                <!-- 캐릭터 정보 -->
                                                <StackPanel Grid.Column="1" Margin="14,0,0,0" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Nickname}" 
                                                               Foreground="{Binding DataContext.OnSurface, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                               FontSize="16" FontWeight="Bold"/>
                                                    <StackPanel Orientation="Horizontal" Margin="0,3,0,0">
                                                        <TextBlock Text="Lv." Foreground="#5AC8FA" FontSize="12" FontWeight="Bold"/>
                                                        <TextBlock Text="{Binding Level}" 
                                                                   Foreground="{Binding DataContext.OnSurface, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                                   FontSize="14" FontWeight="Bold" Margin="2,0,8,0"/>
                                                        <TextBlock Text="{Binding CharacterClass}" 
                                                                   Foreground="{Binding DataContext.OnSurfaceVariant, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                                   FontSize="12"/>
                                                    </StackPanel>
                                                </StackPanel>

                                                <!-- 삭제 버튼 (V 제거) -->
                                                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                                    <Button Command="{Binding DataContext.RemoveCharacterCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                            CommandParameter="{Binding}"
                                                            Width="32" Height="32" Padding="0"
                                                            Background="Transparent" BorderThickness="0" Cursor="Hand"
                                                            ToolTip="캐릭터 삭제" Opacity="0.6">
                                                        <ui:SymbolIcon Symbol="Delete24" FontSize="18" Foreground="#FF6B6B"/>
                                                    </Button>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>

                        <!-- 추가 버튼 영역 -->
                        <Grid Grid.Row="2" Margin="0,20,0,0">
                            <!-- 일반 모드: 추가 버튼 -->
                            <Button Command="{Binding StartAddCharacterCommand}" 
                                    HorizontalAlignment="Stretch" Height="40"
                                    Background="#5AC8FA" Foreground="White" 
                                    Padding="12,0" Cursor="Hand"
                                    IsEnabled="{Binding CanAddCharacter}"
                                    Visibility="{Binding IsAddingCharacter, Converter={StaticResource InverseBoolToVis}}">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border Background="{TemplateBinding Background}" 
                                                            CornerRadius="10" Padding="{TemplateBinding Padding}">
                                                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <Trigger Property="IsEnabled" Value="False">
                                                <Setter Property="Opacity" Value="0.5"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                                <StackPanel Orientation="Horizontal">
                                    <ui:SymbolIcon Symbol="Add24" FontSize="20" Foreground="White" Margin="0,0,8,0"/>
                                    <TextBlock Text="새 캐릭터 추가" FontSize="16" FontWeight="SemiBold"/>
                                </StackPanel>
                            </Button>

                            <!-- 입력 모드: 이름 입력 + 확인/취소 -->
                            <Border Background="{Binding Surface}" CornerRadius="10" Padding="4" BorderBrush="#5AC8FA" BorderThickness="2"
                                    Visibility="{Binding IsAddingCharacter, Converter={StaticResource BoolToVis}}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBox Text="{Binding NewCharacterName, UpdateSourceTrigger=PropertyChanged}" 
                                             Background="Transparent" BorderThickness="0" Height="36"
                                             Foreground="{Binding OnSurface}" FontSize="16" 
                                             Padding="12,5" VerticalContentAlignment="Center"
                                             ToolTip="캐릭터 닉네임 입력">
                                        <TextBox.InputBindings>
                                            <KeyBinding Key="Enter" Command="{Binding ConfirmAddCharacterCommand}"/>
                                            <KeyBinding Key="Esc" Command="{Binding CancelAddCharacterCommand}"/>
                                        </TextBox.InputBindings>
                                    </TextBox>
                                    
                                    <ui:Button Grid.Column="1" Command="{Binding ConfirmAddCharacterCommand}"
                                            Width="36" Height="36" Margin="4,0" Padding="0"
                                            Background="#5AC8FA" BorderThickness="0" Cursor="Hand" CornerRadius="8"
                                            ToolTip="확인">
                                        <ui:SymbolIcon Symbol="Checkmark24" FontSize="20" Foreground="White"/>
                                    </ui:Button>
                                    <ui:Button Grid.Column="2" Command="{Binding CancelAddCharacterCommand}"
                                            Width="36" Height="36" Margin="0,0,4,0" Padding="0"
                                            Background="#FF6B6B" BorderThickness="0" Cursor="Hand" CornerRadius="8"
                                            ToolTip="취소">
                                        <ui:SymbolIcon Symbol="Dismiss24" FontSize="20" Foreground="White"/>
                                    </ui:Button>
                                </Grid>
                            </Border>
                        </Grid>
                    </Grid>
                </Border>
            </Border>

            <!-- 하단바 -->
            <Border Grid.Row="2" Background="#2D3748" CornerRadius="0,0,12,12" Padding="12,8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- 왼쪽: 버전 정보 -->
                    <!-- 왼쪽: 버전 정보 (일반 모드) / 저장 취소 (편집 모드) -->
                    <Grid Grid.Column="0" VerticalAlignment="Center" Margin="4,0,0,0">
                        <TextBlock Text="v1.0.0" Foreground="#64748B" FontSize="11" 
                                   Visibility="{Binding IsEditMode, Converter={StaticResource InverseBoolToVis}}"/>
                        
                        <StackPanel Orientation="Horizontal" Visibility="{Binding IsEditMode, Converter={StaticResource BoolToVis}}">
                            <!-- 저장 버튼 -->
                            <Button Command="{Binding SaveEditCommand}" Content="저장" 
                                    Background="#5AC8FA" Foreground="White" FontWeight="Bold" FontSize="12"
                                    Width="60" Height="28" Padding="0" Margin="0,0,8,0">
                                <Button.Resources>
                                    <Style TargetType="Border">
                                        <Setter Property="CornerRadius" Value="6"/>
                                    </Style>
                                </Button.Resources>
                            </Button>
                            <!-- 취소 버튼 -->
                            <Button Command="{Binding CancelEditCommand}" Content="취소" 
                                    Background="#FF6B6B" Foreground="White" FontWeight="Bold" FontSize="12"
                                    Width="60" Height="28" Padding="0">
                                <Button.Resources>
                                    <Style TargetType="Border">
                                        <Setter Property="CornerRadius" Value="6"/>
                                    </Style>
                                </Button.Resources>
                            </Button>
                        </StackPanel>
                    </Grid>
                    
                    <!-- 오른쪽: 다크/라이트 모드 토글 (ViewModel 바인딩) -->
                    <Button Grid.Column="2" Command="{Binding ToggleThemeCommand}" 
                            Width="36" Height="36" Padding="0" Margin="0,0,12,0"
                            Background="Transparent" BorderThickness="0" Cursor="Hand"
                            ToolTip="다크/라이트 모드 전환">
                        <ui:SymbolIcon Symbol="{Binding ThemeIcon}" FontSize="18" Foreground="#94A3B8"/>
                    </Button>
                    
                    <!-- 메뉴 버튼 -->
                    <Button x:Name="BottomMenuButton" Grid.Column="3" Click="BottomMenuButton_Click" 
                            Cursor="Hand" Padding="14,8">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="Button">
                                            <Border x:Name="Bd" CornerRadius="10" Padding="{TemplateBinding Padding}">
                                                <Border.Background>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                        <GradientStop Color="#5AC8FA" Offset="0"/>
                                                        <GradientStop Color="#4ECDC4" Offset="1"/>
                                                    </LinearGradientBrush>
                                                </Border.Background>
                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="Bd" Property="Opacity" Value="0.9"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </Button.Style>
                        <StackPanel Orientation="Horizontal">
                            <ui:SymbolIcon Symbol="Navigation24" FontSize="16" Foreground="White" Margin="0,0,8,0"/>
                            <TextBlock Text="메뉴" Foreground="White" FontSize="13" FontWeight="SemiBold" VerticalAlignment="Center"/>
                            <ui:SymbolIcon Symbol="ChevronUp24" FontSize="14" Foreground="White" Margin="8,0,0,0"/>
                        </StackPanel>
                    </Button>
                </Grid>
            </Border>
        </Grid>
    
    <!-- 메뉴 오버레이 (Popup 대체) -->
    <Grid x:Name="MenuOverlay" Visibility="Collapsed">
        <!-- 배경 클릭 시 닫기 -->
        <Button Background="#01000000" BorderThickness="0" 
                HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                Click="CloseMenuPopup">
            <Button.Style>
                <Style TargetType="Button">
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="Button">
                                <Border Background="{TemplateBinding Background}"/>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </Button.Style>
        </Button>

        <Border HorizontalAlignment="Right" VerticalAlignment="Bottom"
                Margin="0,0,16,60" CornerRadius="16" Padding="8"
                BorderBrush="#3D4A5C" BorderThickness="1"
                Width="260">
            <Border.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="#2D3748" Offset="0"/>
                    <GradientStop Color="#1A202C" Offset="1"/>
                </LinearGradientBrush>
            </Border.Background>
            <Border.Effect>
                <DropShadowEffect BlurRadius="24" ShadowDepth="4" Opacity="0.4" Color="Black"/>
            </Border.Effect>
            <StackPanel Width="260">
                <!-- 통계 리포트 -->
                <Button Click="OpenStatisticsReport_Click" Cursor="Hand" Margin="0,0,0,4">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="Bd" CornerRadius="12" Padding="12,10" Background="Transparent">
                                            <ContentPresenter/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Bd" Property="Background" Value="#374151"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Border Width="40" Height="40" CornerRadius="10" Margin="0,0,12,0">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                    <GradientStop Color="#7C3AED" Offset="0"/>
                                    <GradientStop Color="#A855F7" Offset="1"/>
                                </LinearGradientBrush>
                            </Border.Background>
                            <ui:SymbolIcon Symbol="DataHistogram24" FontSize="20" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="통계 리포트" Foreground="White" FontSize="14" FontWeight="SemiBold"/>
                            <TextBlock Text="성장 기록 및 장비 변경 내역" Foreground="#94A3B8" FontSize="10" Margin="0,2,0,0"/>
                        </StackPanel>
                    </Grid>
                </Button>
                
                <!-- 전체 캐릭터 현황 (DashboardWindow) -->
                <Button Click="OpenDashboard_Click" Cursor="Hand" Margin="0,0,0,4">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="Bd" CornerRadius="12" Padding="12,10" Background="Transparent">
                                            <ContentPresenter/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Bd" Property="Background" Value="#374151"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Border Width="40" Height="40" CornerRadius="10" Margin="0,0,12,0">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                    <GradientStop Color="#5AC8FA" Offset="0"/>
                                    <GradientStop Color="#818CF8" Offset="1"/>
                                </LinearGradientBrush>
                            </Border.Background>
                            <ui:SymbolIcon Symbol="DataBarVertical24" FontSize="20" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="전체 캐릭터 현황" Foreground="White" FontSize="14" FontWeight="SemiBold"/>
                            <TextBlock Text="모든 캐릭터 숙제 진행도" Foreground="#94A3B8" FontSize="10" Margin="0,2,0,0"/>
                        </StackPanel>
                    </Grid>
                </Button>
                
                <!-- 보스 수익 계산기 -->
                <Button Click="OpenBossCalculator_Click" Cursor="Hand" Margin="0,0,0,4">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="Bd" CornerRadius="12" Padding="12,10" Background="Transparent">
                                            <ContentPresenter/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Bd" Property="Background" Value="#374151"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Border Width="40" Height="40" CornerRadius="10" Margin="0,0,12,0">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                    <GradientStop Color="#F59E0B" Offset="0"/>
                                    <GradientStop Color="#FBBF24" Offset="1"/>
                                </LinearGradientBrush>
                            </Border.Background>
                            <ui:SymbolIcon Symbol="Calculator24" FontSize="20" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="보스 수익 계산기" Foreground="White" FontSize="14" FontWeight="SemiBold"/>
                            <TextBlock Text="주간 보스 결정석 수익 계산" Foreground="#94A3B8" FontSize="10" Margin="0,2,0,0"/>
                        </StackPanel>
                    </Grid>
                </Button>
                
                <!-- 캐릭터 검색 -->
                <Button Click="OpenCharacterSearch_Click" Cursor="Hand">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="Bd" CornerRadius="12" Padding="12,10" Background="Transparent">
                                            <ContentPresenter/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Bd" Property="Background" Value="#374151"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Border Width="40" Height="40" CornerRadius="10" Margin="0,0,12,0">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                    <GradientStop Color="#0EA5E9" Offset="0"/>
                                    <GradientStop Color="#6366F1" Offset="1"/>
                                </LinearGradientBrush>
                            </Border.Background>
                            <ui:SymbolIcon Symbol="PersonSearch24" FontSize="20" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="캐릭터 검색" Foreground="White" FontSize="14" FontWeight="SemiBold"/>
                            <TextBlock Text="다른 캐릭터 장비/코어 조회" Foreground="#94A3B8" FontSize="10" Margin="0,2,0,0"/>
                        </StackPanel>
                    </Grid>
                </Button>
                
                <!-- 구분선 -->
                <Border Height="1" Background="#374151" Margin="12,8"/>
                
                <!-- 설정 -->
                <Button Click="OpenSettings_Click" Cursor="Hand">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="Bd" CornerRadius="12" Padding="12,10" Background="Transparent">
                                            <ContentPresenter/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Bd" Property="Background" Value="#374151"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Border Width="40" Height="40" CornerRadius="10" Margin="0,0,12,0" Background="#475569">
                            <ui:SymbolIcon Symbol="Settings24" FontSize="20" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="설정" Foreground="White" FontSize="14" FontWeight="SemiBold"/>
                            <TextBlock Text="API 키 및 앱 설정" Foreground="#94A3B8" FontSize="10" Margin="0,2,0,0"/>
                        </StackPanel>
                    </Grid>
                </Button>
            </StackPanel>
        </Border>
    </Grid>
    </Grid>
</ui:FluentWindow>
